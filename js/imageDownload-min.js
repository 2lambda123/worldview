SOTE.namespace("SOTE.widget.ImageDownload");SOTE.widget.ImageDownload=function(a,b){this.container=document.getElementById(a);this.coords=null;this.RESOLUTIONS_ON_SCREEN_GEO_ALL=[0.5625,0.28125,0.140625,0.0703125,0.03515625,0.017578125,0.0087890625,0.00439453125,0.002197265625];this.RESOLUTIONS_ON_SERVER_GEO_250m=[0.5625,0.28125,0.140625,0.0703125,0.03515625,0.017578125,0.0087890625,0.00439453125,0.002197265625];if(this.container==null){this.setStatus("Error: element '"+a+"' not found!",true);return}if(b===undefined){b={}}this.alignTo=b.alignTo;this.id=a;this.map=null;this.WMTSLayer=null;if(b.baselayer===undefined){b.baselayer=null}this.baseLayer=b.baselayer;this.value="";this.init()};SOTE.widget.ImageDownload.prototype=new SOTE.widget.Component;SOTE.widget.ImageDownload.prototype.init=function(){this.container.setAttribute("class","imagedownload");var a=this;SOTE.widget.ImageDownload.setPosition(this);$(window).resize(function(){SOTE.widget.ImageDownload.setPosition(a)});if(REGISTRY){REGISTRY.register(this.id,this);REGISTRY.markComponentReady(this.id)}else{alert("No REGISTRY found!  Cannot register Download!")}this.projectionSwitch="geographic";this.map=new OpenLayers.Map({div:"dlMap",theme:null,controls:[],maxExtent:new OpenLayers.Bounds(-180,-90,180,90),projection:"EPSG:4326",numZoomLevels:9,fractionalZoom:false,resolutions:this.RESOLUTIONS_ON_SCREEN_GEO_ALL,allOverlays:false,zoom:2});this.WMTSLayer=new OpenLayers.Layer.WMTS({name:"dl",url:"http://map1a.vis.earthdata.nasa.gov/wmts-geo/wmts.cgi",layer:"Download",matrixSet:"EPSG4326_250m",projection:"EPSG:4326",serverResolutions:this.RESOLUTIONS_ON_SERVER_GEO_250m,visibility:false,tileSize:new OpenLayers.Size(512,512),maxExtent:new OpenLayers.Bounds(-180,-90,180,90),style:"_null",isBaseLayer:true});this.map.addLayer(this.WMTSLayer);var b="<div>Resolution:<select id='selImgResolution'><option value='1'>250m</option><option value='2'>500m</option><option value='4'>1km</option><option value='20'>5km</option><option value='40'>10km</option></select>";b+="<br />Format: <select id='selImgFormat'><option value='JPEG'>JPEG</option><option value='PNG'>PNG</option><option value='Gtiff'>GeoTIFF</option></select>";b+="<br />Raw Image Size: ~ <span id='imgFileSize'> </span> MB <br />(<span id='imgWidth''></span> x <span id='imgHeight'></span> pixels)";b+="<br /><span style='font-size:10px; color:#aaa; font-style:italic;'>(Max Size: 250 MB)</span> ";b+="<br /><input type='button' id='btnImgDownload' value='Download'/>";b+="</div>";$("#"+this.id).html(b)};SOTE.widget.ImageDownload.setPosition=function(a){var c=$("#"+a.alignTo.id).offset();var b=c.left+parseInt($("#"+a.alignTo.id).css("width"))-parseInt($("#"+a.id).css("width"));$("#"+a.id).css("left",b+"px")};SOTE.widget.ImageDownload.prototype.setValue=function(a){this.value=a};SOTE.widget.ImageDownload.prototype.getValue=function(){return this.id+"="+this.value};SOTE.widget.ImageDownload.prototype.updateComponent=function(a){var b=SOTE.util.extractFromQuery("map",a);var k=SOTE.util.extractFromQuery("time",a);var p=SOTE.util.extractFromQuery("camera",a);var n=SOTE.util.extractFromQuery("switch",a);var d=SOTE.util.extractFromQuery("products",a);var o=p.split(",");var r=o[0];var f=o[1];var q=o[2];var e=o[3];this.map.zoomToExtent(new OpenLayers.Bounds.fromString(b));var j=this.map.getExtent();var h=this.map.getLonLatFromViewPortPx(new OpenLayers.Pixel(r,e));var g=this.map.getLonLatFromViewPortPx(new OpenLayers.Pixel(q,f));var c="http://map2.vis.earthdata.nasa.gov/imagegen/?";var i=new Date((k.split("T"))[0]+"T00:00:00");var m="00"+(1+Math.ceil((i-new Date(i.getFullYear(),0,1))/86400000));c+="TIME="+i.getFullYear()+(m).substr((m.length)-3);c+="&extent="+h.lon+"+"+h.lat+"+"+g.lon+"+"+g.lat;c+="&LAYERS="+(((((d).replace("baselayers.","")).replace("overlays.","")).replace(/~/g,"+")).replace(/\./g,"+"));var l=0;var t=0;$("select#selImgResolution").change(function(){imgRes=$("#selImgResolution option:selected").val();l=Math.round((Math.abs(g.lon-h.lon)/0.002197)/Number(imgRes));t=Math.round((Math.abs(g.lat-h.lat)/0.002197)/Number(imgRes));imgFilesize=((l*t*24)/8388608).toFixed(2);$("#imgWidth").text((l));$("#imgHeight").text((t));$("#imgFileSize").text(imgFilesize);if(imgFilesize>250){$("#imgFileSize").css("color","#D99694");$("#btnImgDownload").attr("disabled","disabled")}else{$("#imgFileSize").css("color","white");$("#btnImgDownload").removeAttr("disabled")}}).change();$("#btnImgDownload").unbind("click").click(function(){window.open(c+"&format="+$("#selImgFormat option:selected").val()+"&size="+$("#imgWidth").text()+"+"+$("#imgHeight").text(),"_blank")});this.setValue(c)};SOTE.widget.ImageDownload.prototype.loadFromQuery=function(a){return this.setValue(SOTE.util.extractFromQuery(this.id,a))};SOTE.widget.ImageDownload.prototype.validate=function(){};SOTE.widget.ImageDownload.prototype.setSourceUrl=function(a){};SOTE.widget.ImageDownload.prototype.getSourceUrl=function(){};SOTE.widget.ImageDownload.prototype.setStatus=function(a){};SOTE.widget.ImageDownload.prototype.getStatus=function(){};